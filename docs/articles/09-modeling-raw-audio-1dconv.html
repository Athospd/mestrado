<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Modeling - Raw Audio + 1DConv • mestrado</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/united/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Modeling - Raw Audio + 1DConv">
<meta property="og:description" content="mestrado">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-167498118-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-167498118-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mestrado</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/01-data-gathering.html">Data and MP3 Gathering</a>
    </li>
    <li>
      <a href="../articles/02-data-prep.html">Preparing MP3 for Modelling</a>
    </li>
    <li>
      <a href="../articles/03-data-slicing.html">Slicing Wave Files</a>
    </li>
    <li>
      <a href="../articles/04-data-annotation.html">Data Annotation</a>
    </li>
    <li>
      <a href="../articles/05-data-labeling.html">Data Labelling</a>
    </li>
    <li>
      <a href="../articles/06-data-train-test-spliting.html">Data Train/Test Spliting</a>
    </li>
    <li>
      <a href="../articles/09-modeling-raw-audio-1dconv.html">Modeling - Raw Audio + 1DConv</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/athospd/mestrado">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="09-modeling-raw-audio-1dconv_files/kePrint-0.0.1/kePrint.js"></script><link href="09-modeling-raw-audio-1dconv_files/lightable-0.0.1/lightable.css" rel="stylesheet">
<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Modeling - Raw Audio + 1DConv</h1>
            
      
      
      <div class="hidden name"><code>09-modeling-raw-audio-1dconv.Rmd</code></div>

    </div>

    
    
<div id="reference" class="section level2">
<h2 class="hasAnchor">
<a href="#reference" class="anchor"></a>Reference</h2>
<ul>
<li><p><a href="http://arxiv.org/abs/1904.08990">Abdoli, S., Cardinal, P., Koerich, A L (2019). End-to-End Environmental Sound Classification using a 1D Convolutional Neural Network.</a></p></li>
<li><p><a href="https://blogs.rstudio.com/tensorflow/posts/2020-10-19-torch-image-classification/">Keydana (2020, Oct. 19). RStudio AI Blog: Classifying images with torch.</a></p></li>
</ul>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">mestrado</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs">torch</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">torchaudio</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://purrr.tidyverse.org">purrr</a></span><span class="op">)</span></code></pre></div>
</div>
<div id="birdcallbr-torch-dataset" class="section level2">
<h2 class="hasAnchor">
<a href="#birdcallbr-torch-dataset" class="anchor"></a>BirdcallBR {torch} Dataset</h2>
<p>The function <code><a href="../reference/birdcallbr_dataset.html">birdcallbr_dataset()</a></code> is a [torch::dataset()] ready to be used for modeling with {torch} framework. To know more about torch datasets, see <a href="https://torch.mlverse.org/docs/articles/examples/dataset.html">this</a> and <a href="https://torch.mlverse.org/docs/reference/dataset.html">this</a>.</p>
<p>One of the options offered by <code><a href="../reference/birdcallbr_dataset.html">birdcallbr_dataset()</a></code> is the audio duration. If argument <code>audio_duration = 1</code> then audio samples will be 1 second long. These takes are slices from a given original wav file with potential several seconds long. The current options allowed are 1, 2 and 5 seconds. This will example will work on the 1 second long wave slices.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bcbr2_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/birdcallbr_dataset.html">birdcallbr_dataset</a></span><span class="op">(</span><span class="st">"../data-raw"</span>, audio_duration <span class="op">=</span> <span class="fl">1</span>, download <span class="op">=</span> <span class="cn">FALSE</span>, train <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">bcbr2_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/birdcallbr_dataset.html">birdcallbr_dataset</a></span><span class="op">(</span><span class="st">"../data-raw"</span>, audio_duration <span class="op">=</span> <span class="fl">1</span>, download <span class="op">=</span> <span class="cn">FALSE</span>, train <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">bcbr2_train</span><span class="op">)</span>
<span class="co">#&gt; [1] 17315</span>
<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">bcbr2_test</span><span class="op">)</span>
<span class="co">#&gt; [1] 3316</span></code></pre></div>
<p>All the files were downsampled to 16kHz, so each one of those 17315 + 3316 1sec samples will have 16000 samples.</p>
<div id="an-instance-example" class="section level3">
<h3 class="hasAnchor">
<a href="#an-instance-example" class="anchor"></a>An Instance Example</h3>
<p>Each instance is a named list with the <code>waveform, slice_id, filepath, sample_rate, label, label_one_hot, label_index</code> entrances</p>
<p>First instance from training set:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bcbr2_train</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
<span class="co">#&gt; $waveform</span>
<span class="co">#&gt; torch_tensor</span>
<span class="co">#&gt; Columns 1 to 10 0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Columns 11 to 20 0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Columns 21 to 30 0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Columns 31 to 40 0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Columns 41 to 50 0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Columns 51 to 60 0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Columns 61 to 70 0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Columns 71 to 80 0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Columns 81 to 90 0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Columns 91 to 100 0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0003  0.0004  0.0004</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Columns 101 to 110 0.0004  0.0002  0.0004  0.0003  0.0003  0.0002  0.0004  0.0004  0.0002  0.0004</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Columns 111 to 120 0.0002  0.0002  0.0003  0.0002  0.0004  0.0008  0.0003  0.0002  0.0002  0.0005</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Columns 121 to 130-0.0000  0.0001  0.0002 -0.0000  0.0002  0.0003  0.0002 -0.0000  0.0004  0.0004</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Columns 131 to 140 0.0005 -0.0000  0.0004 -0.0001  0.0003  0.0008  0.0005  0.0006  0.0008  0.0001</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Columns 141 to 150 0.0004  0.0004 -0.0000  0.0001 -0.0000  0.0005  0.0001  0.0001  0.0002  0.0002</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ... [the output was truncated (use n=-1 to disable)]</span>
<span class="co">#&gt; [ CPUFloatType{1,16000} ]</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $slice_id</span>
<span class="co">#&gt; [1] "Glaucidium-minutissimum-1066225@0@1@.wav"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $filepath</span>
<span class="co">#&gt; [1] "../data-raw/BirdcallBR/birdcallbr_v1_1000ms/wavs_1000ms/Glaucidium-minutissimum-1066225@0@1@.wav"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $sample_rate</span>
<span class="co">#&gt; [1] 16000</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $label</span>
<span class="co">#&gt; [1] "Glaucidium-minutissimum"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $label_one_hot</span>
<span class="co">#&gt; torch_tensor</span>
<span class="co">#&gt;  1</span>
<span class="co">#&gt;  0</span>
<span class="co">#&gt;  0</span>
<span class="co">#&gt; [ CPUFloatType{3} ]</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $label_index</span>
<span class="co">#&gt; [1] 1</span></code></pre></div>
<p>The waveform and the mel spectrogram:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># waveform plot</span>
<span class="va">waveform</span> <span class="op">&lt;-</span> <span class="va">bcbr2_train</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">$</span><span class="va">waveform</span><span class="op">$</span><span class="fu">squeeze</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">waveform</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"l"</span>, col <span class="op">=</span> <span class="st">"royalblue"</span><span class="op">)</span>

<span class="co"># mel spec plot</span>
<span class="va">melspec</span> <span class="op">&lt;-</span> <span class="fu">torchaudio</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torchaudio/man/transform_mel_spectrogram.html">transform_mel_spectrogram</a></span><span class="op">(</span><span class="fl">1024</span>, <span class="fl">1024</span>, <span class="fl">128</span>, n_mels <span class="op">=</span> <span class="fl">128</span>, power <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="fu">mestrado</span><span class="fu">::</span><span class="fu"><a href="../reference/plot_pixel_matrix.html">plot_pixel_matrix</a></span><span class="op">(</span>
  <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_log10.html">torch_log10</a></span><span class="op">(</span><span class="fu">melspec</span><span class="op">(</span><span class="va">waveform</span><span class="op">)</span><span class="op">)</span>,
  title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Target bird species: "</span>,  <span class="va">bcbr2_train</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">$</span><span class="va">label</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p><img src="../inst/img/waveform_1dconv.png" width="350"><img src="../inst/img/melspec_1dconv.png" width="350"></p>
</div>
</div>
<div id="device-setup" class="section level2">
<h2 class="hasAnchor">
<a href="#device-setup" class="anchor"></a>Device Setup</h2>
<p>A conveninent code conditioning the device according with the current machine running this code. If <code>cuda</code> is available, then it will be set to be the main device.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">device</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_device.html">torch_device</a></span><span class="op">(</span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://torch.mlverse.org/docs/reference/cuda_is_available.html">cuda_is_available</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="st">"cuda"</span> <span class="kw">else</span> <span class="st">"cpu"</span><span class="op">)</span>

<span class="kw">if</span><span class="op">(</span><span class="va">device</span><span class="op">$</span><span class="va">type</span> <span class="op">==</span> <span class="st">"cuda"</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">num_workers</span> <span class="op">&lt;-</span> <span class="fl">1</span>
  <span class="va">pin_memory</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
  <span class="va">num_workers</span> <span class="op">&lt;-</span> <span class="fl">0</span>
  <span class="va">pin_memory</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="the-batch" class="section level2">
<h2 class="hasAnchor">
<a href="#the-batch" class="anchor"></a>The Batch</h2>
<p>As (probably) the dataset is too big to fit in memory, do things in batches is needed. The <code>collate_fn(batch)</code> function has the task to stack up a list of samples into a big tensor. It will be feeded to a dataloader, which will know how and when fetch a new batch of fresh data.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Make all tensor in a batch the same length by padding with zeros</span>
<span class="va">pad_sequence</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">batch</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">batch</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="fu">t</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="va">batch</span> <span class="op">&lt;-</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_utils_rnn_pad_sequence.html">nn_utils_rnn_pad_sequence</a></span><span class="op">(</span><span class="va">batch</span>, batch_first <span class="op">=</span> <span class="cn">TRUE</span>, padding_value <span class="op">=</span> <span class="fl">0.</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">batch</span><span class="op">$</span><span class="fu">permute</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># Group the list of tensors into a batched tensor</span>
<span class="va">collate_fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">batch</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># A batch list has the form:</span>
  <span class="co"># list of lists: (waveform, slice_id, filepath, sample_rate, label, label_one_hot)</span>
  <span class="co"># Transpose it</span>
  <span class="va">batch</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/transpose.html">transpose</a></span><span class="op">(</span><span class="va">batch</span><span class="op">)</span>
  <span class="va">tensors</span> <span class="op">&lt;-</span> <span class="va">batch</span><span class="op">$</span><span class="va">waveform</span>
  <span class="va">targets</span> <span class="op">&lt;-</span> <span class="va">batch</span><span class="op">$</span><span class="va">label_index</span>
  
  <span class="va">tensors</span> <span class="op">&lt;-</span> <span class="fu">pad_sequence</span><span class="op">(</span><span class="va">tensors</span><span class="op">)</span><span class="op">$</span><span class="fu">to</span><span class="op">(</span>device <span class="op">=</span> <span class="va">device</span><span class="op">)</span>
  <span class="va">targets</span> <span class="op">&lt;-</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_tensor.html">torch_tensor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="va">targets</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="fu">to</span><span class="op">(</span>device <span class="op">=</span> <span class="va">device</span><span class="op">)</span>
  
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>tensors <span class="op">=</span> <span class="va">tensors</span>, targets <span class="op">=</span> <span class="va">targets</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">batch_size</span> <span class="op">&lt;-</span> <span class="fl">64</span>

<span class="co">## dataloader for train set</span>
<span class="va">bcbr2_train_dl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/dataloader.html">dataloader</a></span><span class="op">(</span>
  dataset <span class="op">=</span> <span class="va">bcbr2_train</span>, batch_size <span class="op">=</span> <span class="va">batch_size</span>, 
  shuffle <span class="op">=</span> <span class="cn">TRUE</span>, collate_fn <span class="op">=</span> <span class="va">collate_fn</span>,
  num_workers <span class="op">=</span> <span class="va">num_workers</span>, pin_memory <span class="op">=</span> <span class="va">pin_memory</span>
<span class="op">)</span>

<span class="co">## dataloader for test set</span>
<span class="va">bcbr2_test_dl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/dataloader.html">dataloader</a></span><span class="op">(</span>
  dataset <span class="op">=</span> <span class="va">bcbr2_test</span>, batch_size <span class="op">=</span> <span class="va">batch_size</span>, 
  shuffle <span class="op">=</span> <span class="cn">FALSE</span>, collate_fn <span class="op">=</span> <span class="va">collate_fn</span>,
  num_workers <span class="op">=</span> <span class="va">num_workers</span>, pin_memory <span class="op">=</span> <span class="va">pin_memory</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="the-model" class="section level2">
<h2 class="hasAnchor">
<a href="#the-model" class="anchor"></a>The Model</h2>
<p>This model is inspired by archtecture presented in <a href="http://arxiv.org/abs/1904.08990">(Abdoli, 2019)</a>. Here is called as <code>Raw1DNet</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Raw1DNet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_module.html">nn_module</a></span><span class="op">(</span>
  <span class="st">"Raw1DNet"</span>,
  initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">self</span><span class="op">$</span><span class="va">conv1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_conv1d.html">nn_conv1d</a></span><span class="op">(</span> <span class="fl">1</span>,  <span class="fl">16</span>, kernel_size <span class="op">=</span> <span class="fl">64</span>, stride <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="co"># (1, 16000) --&gt; (16, 7969)</span>
    <span class="va">self</span><span class="op">$</span><span class="va">bn1</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_batch_norm1d.html">nn_batch_norm1d</a></span><span class="op">(</span><span class="fl">16</span><span class="op">)</span> 
    <span class="va">self</span><span class="op">$</span><span class="va">pool1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_avg_pool1d.html">nn_avg_pool1d</a></span><span class="op">(</span><span class="fl">8</span><span class="op">)</span> <span class="co"># (16, 996)</span>
    <span class="va">self</span><span class="op">$</span><span class="va">conv2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_conv1d.html">nn_conv1d</a></span><span class="op">(</span><span class="fl">16</span>,  <span class="fl">32</span>, kernel_size <span class="op">=</span> <span class="fl">32</span>, stride <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="co"># (16, 1996) --&gt; (32, 483)</span>
    <span class="va">self</span><span class="op">$</span><span class="va">bn2</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_batch_norm1d.html">nn_batch_norm1d</a></span><span class="op">(</span><span class="fl">32</span><span class="op">)</span>
    <span class="va">self</span><span class="op">$</span><span class="va">pool2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_avg_pool1d.html">nn_avg_pool1d</a></span><span class="op">(</span><span class="fl">8</span><span class="op">)</span> <span class="co"># (32, 60)</span>
    <span class="va">self</span><span class="op">$</span><span class="va">conv3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_conv1d.html">nn_conv1d</a></span><span class="op">(</span><span class="fl">32</span>,  <span class="fl">64</span>, kernel_size <span class="op">=</span> <span class="fl">16</span>, stride <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="co"># (32, 123) --&gt; (64, 23)</span>
    <span class="va">self</span><span class="op">$</span><span class="va">bn3</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_batch_norm1d.html">nn_batch_norm1d</a></span><span class="op">(</span><span class="fl">64</span><span class="op">)</span>
    <span class="va">self</span><span class="op">$</span><span class="va">pool3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_avg_pool1d.html">nn_avg_pool1d</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span> <span class="co"># (64, 11)</span>
    <span class="va">self</span><span class="op">$</span><span class="va">conv4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_conv1d.html">nn_conv1d</a></span><span class="op">(</span><span class="fl">64</span>, <span class="fl">128</span>, kernel_size <span class="op">=</span>  <span class="fl">2</span>, stride <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># (64, 11) --&gt; (128, 10)</span>
    <span class="va">self</span><span class="op">$</span><span class="va">bn4</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_batch_norm1d.html">nn_batch_norm1d</a></span><span class="op">(</span><span class="fl">128</span><span class="op">)</span>
    <span class="va">self</span><span class="op">$</span><span class="va">pool4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_avg_pool1d.html">nn_avg_pool1d</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>
    <span class="va">self</span><span class="op">$</span><span class="va">lin1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_linear.html">nn_linear</a></span><span class="op">(</span><span class="fl">128</span>, <span class="fl">64</span><span class="op">)</span>
    <span class="va">self</span><span class="op">$</span><span class="va">bn5</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_batch_norm1d.html">nn_batch_norm1d</a></span><span class="op">(</span><span class="fl">64</span><span class="op">)</span>
    <span class="va">self</span><span class="op">$</span><span class="va">lin2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_linear.html">nn_linear</a></span><span class="op">(</span><span class="fl">64</span>, <span class="fl">10</span><span class="op">)</span>
    <span class="va">self</span><span class="op">$</span><span class="va">bn6</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_batch_norm1d.html">nn_batch_norm1d</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>
    <span class="va">self</span><span class="op">$</span><span class="va">lin3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_linear.html">nn_linear</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">3</span><span class="op">)</span>
    <span class="va">self</span><span class="op">$</span><span class="va">softmax</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_log_softmax.html">nn_log_softmax</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>
  <span class="op">}</span>,
  
  forward <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">out</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">%&gt;%</span>
      <span class="va">self</span><span class="op">$</span><span class="fu">conv1</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nnf_relu.html">nnf_relu</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="va">self</span><span class="op">$</span><span class="fu">bn1</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="va">self</span><span class="op">$</span><span class="fu">pool1</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="va">self</span><span class="op">$</span><span class="fu">conv2</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nnf_relu.html">nnf_relu</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="va">self</span><span class="op">$</span><span class="fu">bn2</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="va">self</span><span class="op">$</span><span class="fu">pool2</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="va">self</span><span class="op">$</span><span class="fu">conv3</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nnf_relu.html">nnf_relu</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="va">self</span><span class="op">$</span><span class="fu">bn3</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="va">self</span><span class="op">$</span><span class="fu">pool3</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="va">self</span><span class="op">$</span><span class="fu">conv4</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nnf_relu.html">nnf_relu</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="va">self</span><span class="op">$</span><span class="fu">bn4</span><span class="op">(</span><span class="op">)</span> 
    
    <span class="va">out</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">pool4</span><span class="op">(</span><span class="va">out</span><span class="op">)</span><span class="op">$</span><span class="fu">squeeze</span><span class="op">(</span><span class="fl">3</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="va">self</span><span class="op">$</span><span class="fu">lin1</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="va">self</span><span class="op">$</span><span class="fu">bn5</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nnf_relu.html">nnf_relu</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="va">self</span><span class="op">$</span><span class="fu">lin2</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="va">self</span><span class="op">$</span><span class="fu">bn6</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nnf_relu.html">nnf_relu</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="va">self</span><span class="op">$</span><span class="fu">lin3</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="va">self</span><span class="op">$</span><span class="fu">softmax</span><span class="op">(</span><span class="op">)</span>
    
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">)</span></code></pre></div>
<p>Instantiating…</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">Raw1DNet</span><span class="op">(</span><span class="op">)</span>
<span class="va">model</span><span class="op">$</span><span class="fu">to</span><span class="op">(</span>device <span class="op">=</span> <span class="va">device</span><span class="op">)</span>
<span class="co"># model(bcbr2_train_dl$.iter()$.next()$tensors)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="va">parameters</span><span class="op">)</span>
<span class="co">#&gt; List of 26</span>
<span class="co">#&gt;  $ conv1.weight:Float [1:16, 1:1, 1:64]</span>
<span class="co">#&gt;  $ conv1.bias  :Float [1:16]</span>
<span class="co">#&gt;  $ bn1.weight  :Float [1:16]</span>
<span class="co">#&gt;  $ bn1.bias    :Float [1:16]</span>
<span class="co">#&gt;  $ conv2.weight:Float [1:32, 1:16, 1:32]</span>
<span class="co">#&gt;  $ conv2.bias  :Float [1:32]</span>
<span class="co">#&gt;  $ bn2.weight  :Float [1:32]</span>
<span class="co">#&gt;  $ bn2.bias    :Float [1:32]</span>
<span class="co">#&gt;  $ conv3.weight:Float [1:64, 1:32, 1:16]</span>
<span class="co">#&gt;  $ conv3.bias  :Float [1:64]</span>
<span class="co">#&gt;  $ bn3.weight  :Float [1:64]</span>
<span class="co">#&gt;  $ bn3.bias    :Float [1:64]</span>
<span class="co">#&gt;  $ conv4.weight:Float [1:128, 1:64, 1:2]</span>
<span class="co">#&gt;  $ conv4.bias  :Float [1:128]</span>
<span class="co">#&gt;  $ bn4.weight  :Float [1:128]</span>
<span class="co">#&gt;  $ bn4.bias    :Float [1:128]</span>
<span class="co">#&gt;  $ lin1.weight :Float [1:64, 1:128]</span>
<span class="co">#&gt;  $ lin1.bias   :Float [1:64]</span>
<span class="co">#&gt;  $ bn5.weight  :Float [1:64]</span>
<span class="co">#&gt;  $ bn5.bias    :Float [1:64]</span>
<span class="co">#&gt;  $ lin2.weight :Float [1:10, 1:64]</span>
<span class="co">#&gt;  $ lin2.bias   :Float [1:10]</span>
<span class="co">#&gt;  $ bn6.weight  :Float [1:10]</span>
<span class="co">#&gt;  $ bn6.bias    :Float [1:10]</span>
<span class="co">#&gt;  $ lin3.weight :Float [1:3, 1:10]</span>
<span class="co">#&gt;  $ lin3.bias   :Float [1:3]</span>

<span class="va">count_parameters</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">requires</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_lgl</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="va">parameters</span>, <span class="op">~</span><span class="va">.</span><span class="op">$</span><span class="va">requires_grad</span><span class="op">)</span>
  <span class="va">params</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_int</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="va">parameters</span><span class="op">[</span><span class="va">requires</span><span class="op">]</span>, <span class="op">~</span><span class="va">.</span><span class="op">$</span><span class="fu">numel</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">params</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu">count_parameters</span><span class="op">(</span><span class="va">model</span><span class="op">)</span>
<span class="co">#&gt; [1] 76367</span></code></pre></div>
</div>
<div id="loss-optmizer-and-scheduler" class="section level2">
<h2 class="hasAnchor">
<a href="#loss-optmizer-and-scheduler" class="anchor"></a>Loss, Optmizer and Scheduler</h2>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">criterion</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_nll_loss.html">nn_nll_loss</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">optimizer</span> <span class="op">&lt;-</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://torch.mlverse.org/docs/reference/optim_sgd.html">optim_sgd</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="va">parameters</span>, lr <span class="op">=</span> <span class="fl">0.005</span>, weight_decay <span class="op">=</span> <span class="fl">0.00001</span><span class="op">)</span>
<span class="va">scheduler</span> <span class="op">&lt;-</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://torch.mlverse.org/docs/reference/lr_step.html">lr_step</a></span><span class="op">(</span><span class="va">optimizer</span>, step_size <span class="op">=</span> <span class="fl">10</span>, gamma <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> </code></pre></div>
</div>
<div id="train-and-test-loops" class="section level2">
<h2 class="hasAnchor">
<a href="#train-and-test-loops" class="anchor"></a>Train and Test Loops</h2>
<p>Train loop:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">train</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">epoch</span>, <span class="va">log_interval</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">model</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="op">)</span>
  
  <span class="va">batches</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/enumerate.html">enumerate</a></span><span class="op">(</span><span class="va">bcbr2_train_dl</span><span class="op">)</span>
  <span class="kw">for</span><span class="op">(</span><span class="va">batch_idx</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">batches</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">batch</span> <span class="op">&lt;-</span> <span class="va">batches</span><span class="op">[</span><span class="va">batch_idx</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
    <span class="va">data</span> <span class="op">&lt;-</span> <span class="va">batch</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">to</span><span class="op">(</span>device <span class="op">=</span> <span class="va">device</span><span class="op">)</span>
    <span class="va">target</span> <span class="op">&lt;-</span> <span class="va">batch</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">to</span><span class="op">(</span>device <span class="op">=</span> <span class="va">device</span><span class="op">)</span>
    
    <span class="va">output</span> <span class="op">&lt;-</span> <span class="fu">model</span><span class="op">(</span><span class="va">data</span><span class="op">)</span>
    <span class="va">loss</span> <span class="op">&lt;-</span> <span class="fu">criterion</span><span class="op">(</span><span class="va">output</span>, <span class="va">target</span><span class="op">)</span><span class="op">$</span><span class="fu">to</span><span class="op">(</span>device <span class="op">=</span> <span class="va">device</span><span class="op">)</span>
    
    <span class="va">optimizer</span><span class="op">$</span><span class="fu">zero_grad</span><span class="op">(</span><span class="op">)</span>
    <span class="va">loss</span><span class="op">$</span><span class="fu">backward</span><span class="op">(</span><span class="op">)</span>
    <span class="va">optimizer</span><span class="op">$</span><span class="fu">step</span><span class="op">(</span><span class="op">)</span>
    
    <span class="co"># update progress bar</span>
    <span class="va">pbar</span><span class="op">$</span><span class="fu">tick</span><span class="op">(</span>tokens <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="va">loss</span><span class="op">$</span><span class="fu">item</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    
    <span class="co"># record loss</span>
    <span class="va">losses</span> <span class="op">&lt;&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">losses</span>, <span class="va">loss</span><span class="op">$</span><span class="fu">item</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> 
    <span class="kw">if</span><span class="op">(</span><span class="va">batch_idx</span> <span class="op">%%</span> <span class="va">log_interval</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw">if</span><span class="op">(</span><span class="va">batch_idx</span> <span class="op">!=</span> <span class="va">log_interval</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html">dev.off</a></span><span class="op">(</span><span class="op">)</span>
      <span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="va">losses</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"l"</span>, col <span class="op">=</span> <span class="st">"royalblue"</span><span class="op">)</span>
    <span class="op">}</span>
  <span class="op">}</span>
<span class="op">}</span></code></pre></div>
<p>Test loop:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># count number of correct predictions</span>
<span class="va">number_of_correct</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pred</span>, <span class="va">target</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">pred</span><span class="op">$</span><span class="fu">squeeze</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">eq</span><span class="op">(</span><span class="va">target</span><span class="op">)</span><span class="op">$</span><span class="fu">sum</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">item</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># find most likely label index for each element in the batch</span>
<span class="va">get_likely_index</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">tensor</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">tensor</span><span class="op">$</span><span class="fu">argmax</span><span class="op">(</span>dim<span class="op">=</span><span class="op">-</span><span class="fl">1L</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1L</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">test</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">epoch</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">model</span><span class="op">$</span><span class="fu">eval</span><span class="op">(</span><span class="op">)</span>
  <span class="va">correct</span> <span class="op">&lt;-</span> <span class="fl">0</span>
  <span class="va">batches</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/enumerate.html">enumerate</a></span><span class="op">(</span><span class="va">bcbr2_test_dl</span><span class="op">)</span>
  <span class="va">obs_vs_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>obs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">integer</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>, pred <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span>
  <span class="kw">for</span><span class="op">(</span><span class="va">batch_idx</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">batches</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">batch</span> <span class="op">&lt;-</span> <span class="va">batches</span><span class="op">[</span><span class="va">batch_idx</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
    <span class="va">data</span> <span class="op">&lt;-</span> <span class="va">batch</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">to</span><span class="op">(</span>device <span class="op">=</span> <span class="va">device</span><span class="op">)</span>
    <span class="va">target</span> <span class="op">&lt;-</span> <span class="va">batch</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">to</span><span class="op">(</span>device <span class="op">=</span> <span class="va">device</span><span class="op">)</span>
    
    <span class="va">output</span> <span class="op">&lt;-</span> <span class="fu">model</span><span class="op">(</span><span class="va">data</span><span class="op">)</span>
    
    <span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu">get_likely_index</span><span class="op">(</span><span class="va">output</span><span class="op">)</span>
    <span class="va">correct</span> <span class="op">&lt;-</span> <span class="va">correct</span> <span class="op">+</span> <span class="fu">number_of_correct</span><span class="op">(</span><span class="va">pred</span>, <span class="va">target</span><span class="op">)</span>
    <span class="va">obs_vs_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span>
      <span class="va">obs_vs_pred</span>, 
      <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
        obs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">target</span><span class="op">$</span><span class="fu">to</span><span class="op">(</span>device <span class="op">=</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_device.html">torch_device</a></span><span class="op">(</span><span class="st">"cpu"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, 
        pred <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">pred</span><span class="op">$</span><span class="fu">to</span><span class="op">(</span>device <span class="op">=</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_device.html">torch_device</a></span><span class="op">(</span><span class="st">"cpu"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
      <span class="op">)</span>
    <span class="op">)</span>
    
    <span class="co"># update progress bar</span>
    <span class="va">pbar</span><span class="op">$</span><span class="fu">tick</span><span class="op">(</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"Test Epoch: {epoch} Accuracy: {correct}/{length(bcbr2_test_dl$dataset)} ({scales::percent(correct / length(bcbr2_test_dl$dataset))})"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">obs_vs_pred</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_all</a></span><span class="op">(</span><span class="va">as.factor</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">yardstick</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/yardstick/man/conf_mat.html">conf_mat</a></span><span class="op">(</span><span class="va">obs</span>, <span class="va">pred</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="model-fitting" class="section level2">
<h2 class="hasAnchor">
<a href="#model-fitting" class="anchor"></a>Model Fitting</h2>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">log_interval</span> <span class="op">&lt;-</span> <span class="fl">40</span>
<span class="va">n_epoch</span> <span class="op">&lt;-</span> <span class="fl">50</span>

<span class="va">losses</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>

<span class="kw">for</span><span class="op">(</span><span class="va">epoch</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq.int</a></span><span class="op">(</span><span class="va">n_epoch</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Epoch "</span>, <span class="va">epoch</span>, <span class="st">"/"</span>, <span class="va">n_epoch</span>, <span class="st">"\n"</span><span class="op">)</span><span class="op">)</span>
  <span class="va">pbar</span> <span class="op">&lt;-</span> <span class="fu">progress</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/progress/man/progress_bar.html">progress_bar</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>total <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">bcbr2_train_dl</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">bcbr2_test_dl</span><span class="op">)</span><span class="op">)</span>, clear <span class="op">=</span> <span class="cn">FALSE</span>, width <span class="op">=</span> <span class="fl">90</span>,
                                     incomplete <span class="op">=</span> <span class="st">"."</span>, format <span class="op">=</span> <span class="st">"[:bar] [:current/:total :percent] - ETA: :eta - loss: :loss"</span><span class="op">)</span>
  
  <span class="fu">train</span><span class="op">(</span><span class="va">model</span>, <span class="va">epoch</span>, <span class="va">log_interval</span><span class="op">)</span>
  <span class="fu">test</span><span class="op">(</span><span class="va">model</span>, <span class="va">epoch</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">losses</span>, type <span class="op">=</span> <span class="st">"l"</span>, col <span class="op">=</span> <span class="st">"royalblue"</span><span class="op">)</span>
  <span class="va">scheduler</span><span class="op">$</span><span class="fu">step</span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#&gt; [================================================] [323/323 100%] - ETA:  0s - loss: :loss</span>
<span class="co">#&gt; Test Epoch: 2    Accuracy: 2713/3316 (82%)</span>
<span class="co">#&gt;           Truth</span>
<span class="co">#&gt; Prediction    1    2    3</span>
<span class="co">#&gt;          1  168   24    2</span>
<span class="co">#&gt;          2  136 2338  403</span>
<span class="co">#&gt;          3    2   36  207</span>
<span class="co">#&gt; Epoch 3/50</span>
<span class="co">#&gt; [==========&gt;.........................] [102/323  32%] - ETA:  1m - loss: 0.534031510353088</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; (truncated...)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Test Epoch: 50/50</span>
<span class="co">#&gt; Accuracy: 2934/3316 (88%)</span>
<span class="co">#&gt;           Truth</span>
<span class="co">#&gt; Prediction    1    2    3</span>
<span class="co">#&gt;          1  246   39    3</span>
<span class="co">#&gt;          2   60 2286  207</span>
<span class="co">#&gt;          3    0   73  402</span></code></pre></div>
</div>
<div id="performance" class="section level2">
<h2 class="hasAnchor">
<a href="#performance" class="anchor"></a>Performance</h2>
<img src="../inst/img/losses_1dconv.png" width="309"><table class="table table">
<caption>
<strong>Teste accuracy of 88%</strong>
</caption>
<thead><tr>
<th style="text-align:left;">
Prediction
</th>
<th style="text-align:center;">
Galu
</th>
<th style="text-align:center;">
Unknown
</th>
<th style="text-align:center;">
Sp
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
Galu
</td>
<td style="text-align:center;">
246
</td>
<td style="text-align:center;">
39
</td>
<td style="text-align:center;">
3
</td>
</tr>
<tr>
<td style="text-align:left;">
Unknown
</td>
<td style="text-align:center;">
60
</td>
<td style="text-align:center;">
2286
</td>
<td style="text-align:center;">
207
</td>
</tr>
<tr>
<td style="text-align:left;">
Sp
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
73
</td>
<td style="text-align:center;">
402
</td>
</tr>
</tbody>
</table>
</div>
<div id="wrap-up" class="section level2">
<h2 class="hasAnchor">
<a href="#wrap-up" class="anchor"></a>Wrap Up</h2>
<ul>
<li>Input: raw audio.</li>
<li>Archtecture: combo os 1D convolution layers + relu + batch norm.</li>
<li>Test acc of 88%, not bad for such simple approach! But can be improved for sure. There are (Mel) Spectrograms, MFCCs and 2D convolutions to be explored.</li>
</ul>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># stores ------------------------------------------------------</span>
<span class="co"># torch::torch_save(model, "inst/modelos/raw_1dconv_1seg.pt")</span>

<span class="co"># restore -----------------------------------------------------</span>
<span class="co"># model &lt;- torch::torch_load("inst/modelos/raw_1dconv_1seg.pt")</span>
<span class="co"># model$parameters %&gt;% purrr::walk(function(param) param$requires_grad_(TRUE))</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://github.com/athospd">Athos Damiani</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
